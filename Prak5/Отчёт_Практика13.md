# Практическая работа №13

**Тема:** Разработка мобильного приложения с использованием библиотек `Retrofit` и `Glide` для работы с сетью.

## Цель работы

1. Освоить принципы выполнения сетевых запросов в Android-приложении с использованием библиотеки `Retrofit`.
2. Научиться обрабатывать данные, полученные от REST API в формате JSON.
3. Реализовать загрузку и отображение изображений из сети с помощью библиотеки `Glide`.
4. Интегрировать сетевую работу в архитектуру Clean Architecture с паттерном MVVM.

---

## Реализация загрузки данных о фильмах с помощью `Retrofit`

### 1. Настройка проекта MovieProject

В файл `gradle/libs.versions.toml` были добавлены зависимости:
```toml
[versions]
retrofit = "2.9.0"
glide = "4.16.0"
okhttp = "4.12.0"

[libraries]
retrofit = { group = "com.squareup.retrofit2", name = "retrofit", version.ref = "retrofit" }
retrofit-converter-gson = { group = "com.squareup.retrofit2", name = "converter-gson", version.ref = "retrofit" }
glide = { group = "com.github.bumptech.glide", name = "glide", version.ref = "glide" }
glide-compiler = { group = "com.github.bumptech.glide", name = "compiler", version.ref = "glide" }
okhttp-logging-interceptor = { group = "com.squareup.okhttp3", name = "logging-interceptor", version.ref = "okhttp" }
```

В `AndroidManifest.xml` добавлены разрешения:
```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

<application
    android:usesCleartextTraffic="true"
    ...>
```

### 2. Создание моделей данных (DTO)

Были созданы классы для десериализации JSON-ответов от TMDB API:

**MovieDto.java** - модель для одного фильма:
```java
public class MovieDto {
    @SerializedName("id")
    private int id;
    
    @SerializedName("title")
    private String title;
    
    @SerializedName("overview")
    private String overview;
    
    @SerializedName("genre_ids")
    private List<Integer> genreIds;
    
    @SerializedName("release_date")
    private String releaseDate;
    
    @SerializedName("vote_average")
    private double voteAverage;
    
    @SerializedName("poster_path")
    private String posterPath;
    
    public String getFullPosterUrl() {
        if (posterPath != null && !posterPath.isEmpty()) {
            return "https://image.tmdb.org/t/p/w500" + posterPath;
        }
        return "https://via.placeholder.com/500x750?text=No+Image";
    }
}
```

**MoviesResponse.java** - обёртка для списка фильмов:
```java
public class MoviesResponse {
    @SerializedName("results")
    private List<MovieDto> results;
    
    @SerializedName("page")
    private int page;
    
    @SerializedName("total_pages")
    private int totalPages;
}
```

### 3. Создание API-интерфейса

Был создан интерфейс `MovieApiService.java` с аннотациями Retrofit для работы с TMDB API:
```java
public interface MovieApiService {
    @GET("movie/popular")
    Call<MoviesResponse> getPopularMovies(
            @Query("api_key") String apiKey,
            @Query("language") String language,
            @Query("page") int page
    );
    
    @GET("movie/top_rated")
    Call<MoviesResponse> getTopRatedMovies(
            @Query("api_key") String apiKey,
            @Query("language") String language,
            @Query("page") int page
    );
}
```

### 4. Настройка Retrofit клиента

Класс `RetrofitClient.java` реализован как Singleton с настройками логирования:
```java
public class RetrofitClient {
    private static final String BASE_URL = "https://api.themoviedb.org/3/";
    public static final String API_KEY = "demo_key_use_your_own";
    
    public static Retrofit getRetrofitInstance() {
        if (retrofit == null) {
            // Логирование HTTP запросов
            HttpLoggingInterceptor loggingInterceptor = new HttpLoggingInterceptor();
            loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.BODY);
            
            // Настройка OkHttpClient
            OkHttpClient okHttpClient = new OkHttpClient.Builder()
                    .addInterceptor(loggingInterceptor)
                    .connectTimeout(30, TimeUnit.SECONDS)
                    .readTimeout(30, TimeUnit.SECONDS)
                    .writeTimeout(30, TimeUnit.SECONDS)
                    .build();
            
            retrofit = new Retrofit.Builder()
                    .baseUrl(BASE_URL)
                    .client(okHttpClient)
                    .addConverterFactory(GsonConverterFactory.create())
                    .build();
        }
        return retrofit;
    }
}
```

### 5. Создание Mapper для преобразования данных

Класс `MovieMapper.java` преобразует DTO в доменные модели:
```java
public class MovieMapper {
    public static Movie mapToDomain(MovieDto dto) {
        return new Movie(
                dto.getId(),
                dto.getTitle(),
                dto.getOverview(),
                mapGenreIdsToString(dto.getGenreIds()),
                extractYearFromDate(dto.getReleaseDate()),
                dto.getVoteAverage(),
                dto.getFullPosterUrl()
        );
    }
    
    private static String mapGenreIdsToString(List<Integer> genreIds) {
        // Маппинг ID жанров TMDB в русские названия
        switch (genreIds.get(0)) {
            case 28: return "Боевик";
            case 35: return "Комедия";
            case 18: return "Драма";
            case 878: return "Фантастика";
            // ... остальные жанры
            default: return "Разное";
        }
    }
}
```

### 6. Интеграция с репозиторием

Класс `NetworkApi.java` был модифицирован для выполнения сетевых запросов:
```java
public class NetworkApi {
    private final MovieApiService apiService;
    private final FakeMovieApi fakeMovieApi;
    
    public List<Movie> getMoviesFromNetwork() {
        try {
            Call<MoviesResponse> call = apiService.getPopularMovies();
            Response<MoviesResponse> response = call.execute();
            
            if (response.isSuccessful() && response.body() != null) {
                return MovieMapper.mapToDomainList(response.body().getResults());
            } else {
                // Fallback на локальные данные при ошибке
                return fakeMovieApi.fetchMovies();
            }
        } catch (IOException e) {
            // При отсутствии сети используем заглушку
            return fakeMovieApi.fetchMovies();
        }
    }
}
```

### 7. Обновление FakeMovieApi

В класс `FakeMovieApi.java` были добавлены URL постеров для всех 12 фильмов:
```java
movieStub.add(new Movie(1, "Побег из Шоушенка", 
    "История банкира, несправедливо осужденного...", 
    "Драма", 1994, 9.3,
    "https://m.media-amazon.com/images/M/MV5BNDE3ODcxYzMt...jpg"));

movieStub.add(new Movie(2, "Крёстный отец",
    "Хроника криминальной семьи Корлеоне...",
    "Криминал, Драма", 1972, 9.2,
    "https://m.media-amazon.com/images/M/MV5BM2MyNjYxNmUt...jpg"));
// ... всего 12 фильмов с постерами
```

---

## Интеграция библиотеки `Glide` для загрузки изображений

### 1. Модификация макета

В `item_movie.xml` был добавлен `ImageView` для постера фильма:
```xml
<LinearLayout android:orientation="horizontal">
    <ImageView
        android:id="@+id/moviePosterImageView"
        android:layout_width="100dp"
        android:layout_height="150dp"
        android:scaleType="centerCrop"
        android:contentDescription="@string/movie_poster"/>
    
    <!-- Информация о фильме -->
    <LinearLayout android:orientation="vertical">
        <TextView android:id="@+id/movieTitleTextView" />
        <TextView android:id="@+id/movieGenreTextView" />
        <TextView android:id="@+id/movieDescriptionTextView" />
    </LinearLayout>
</LinearLayout>
```

### 2. Обновление Адаптера

Класс `MovieAdapter.java` был модифицирован для загрузки постеров:
```java
class MovieViewHolder extends RecyclerView.ViewHolder {
    private final ImageView posterImageView;
    private final TextView titleTextView;
    // ... остальные view
    
    public void bind(Movie movie) {
        titleTextView.setText(movie.getName());
        genreTextView.setText(movie.getGenre());
        ratingTextView.setText(String.format("%.1f", movie.getRating()));
        
        // Загрузка постера с помощью Glide
        if (movie.getImageUrl() != null && !movie.getImageUrl().isEmpty()) {
            Glide.with(itemView.getContext())
                    .load(movie.getImageUrl())
                    .centerCrop()
                    .placeholder(R.drawable.ic_launcher_background)
                    .error(R.drawable.ic_launcher_background)
                    .diskCacheStrategy(DiskCacheStrategy.ALL)
                    .into(posterImageView);
        }
    }
}
```

### 3. Результаты работы MovieProject

Приложение успешно:
- Загружает список популярных фильмов из TMDB API
- Отображает постеры фильмов с помощью Glide
- Использует fallback на локальные данные при отсутствии сети
- Кеширует изображения для быстрой повторной загрузки

---

## Применение в проекте Askon

### 1. Добавление зависимостей

В проект Askon были добавлены те же зависимости Retrofit и Glide через `libs.versions.toml`.

### 2. Обновление ExpertAdapter

Класс `ExpertAdapter.java` был обновлён для загрузки аватаров экспертов:
```java
public void bind(Expert expert, OnExpertClickListener listener) {
    nameText.setText(expert.getName());
    ratingText.setText(String.format("⭐ %.1f (%d)", 
        expert.getRating(), expert.getReviewCount()));
    priceText.setText(String.format("$%d/hr", expert.getHourlyRate()));
    
    // Загрузка аватара с Glide
    if (expert.getPhotoUrl() != null && !expert.getPhotoUrl().isEmpty()) {
        Glide.with(itemView.getContext())
                .load(expert.getPhotoUrl())
                .circleCrop() // Круглое изображение для аватара
                .placeholder(R.drawable.ic_launcher_background)
                .error(R.drawable.ic_launcher_background)
                .diskCacheStrategy(DiskCacheStrategy.ALL)
                .into(avatarImage);
    }
    
    // Отображение навыков
    skillsChipGroup.removeAllViews();
    for (String skill : expert.getSkills()) {
        Chip chip = new Chip(itemView.getContext());
        chip.setText(skill);
        skillsChipGroup.addView(chip);
    }
}
```

### 3. Особенности реализации

- Использована трансформация `.circleCrop()` для круглых аватаров экспертов
- Применена та же стратегия кеширования `DiskCacheStrategy.ALL`
- Сохранена совместимость с существующей архитектурой Clean Architecture

---


**Преимущества такого подхода:**
- Слой Domain не зависит от Android и сетевых библиотек
- Легко тестировать каждый слой отдельно
- Можно заменить Retrofit на другую библиотеку без изменения бизнес-логики
- Fallback на локальные данные повышает надёжность

---

## Итоги

В ходе выполнения практической работы были успешно освоены технологии для работы с сетью в Android

## Демонстрационный модуль retrofitapp

Помимо основной реализации в `MovieProject` был создан отдельный модуль **retrofitapp** для демонстрации работы с Retrofit и Glide в изолированном приложении.

### Ключевые компоненты

**RetrofitDemoActivity.java:**
```java
public class RetrofitDemoActivity extends AppCompatActivity {
    private RecyclerView recyclerView;
    private MovieAdapter adapter;
    private MovieApiClient apiClient;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_retrofit_demo);
        
        recyclerView = findViewById(R.id.moviesRecyclerView);
        recyclerView.setLayoutManager(new LinearLayoutManager(this));
        
        adapter = new MovieAdapter(new ArrayList<>());
        recyclerView.setAdapter(adapter);
        
        apiClient = new MovieApiClient();
        loadMovies();
    }
    
    private void loadMovies() {
        apiClient.getPopularMovies(new MovieApiClient.MovieCallback() {
            @Override
            public void onSuccess(List<MovieDto> movies) {
                runOnUiThread(() -> adapter.updateMovies(movies));
            }
            
            @Override
            public void onError(String error) {
                runOnUiThread(() -> 
                    Toast.makeText(RetrofitDemoActivity.this, error, Toast.LENGTH_LONG).show()
                );
            }
        });
    }
}
```

**MovieApiClient.java** - упрощённый клиент с логированием:
```java
public class MovieApiClient {
    private static final String BASE_URL = "https://api.themoviedb.org/3/";
    private static final String API_KEY = "your_api_key_here";
    
    private final MovieApiService apiService;
    
    public MovieApiClient() {
        HttpLoggingInterceptor logging = new HttpLoggingInterceptor();
        logging.setLevel(HttpLoggingInterceptor.Level.BODY);
        
        OkHttpClient client = new OkHttpClient.Builder()
                .addInterceptor(logging)
                .connectTimeout(30, TimeUnit.SECONDS)
                .readTimeout(30, TimeUnit.SECONDS)
                .build();
        
        Retrofit retrofit = new Retrofit.Builder()
                .baseUrl(BASE_URL)
                .client(client)
                .addConverterFactory(GsonConverterFactory.create())
                .build();
        
        apiService = retrofit.create(MovieApiService.class);
    }
    
    public interface MovieCallback {
        void onSuccess(List<MovieDto> movies);
        void onError(String error);
    }
}
```

**MovieAdapter.java** с загрузкой изображений через Glide:
```java
public class MovieAdapter extends RecyclerView.Adapter<MovieAdapter.MovieViewHolder> {
    static class MovieViewHolder extends RecyclerView.ViewHolder {
        public void bind(MovieDto movie) {
            titleTextView.setText(movie.getTitle());
            
            String posterUrl = movie.getFullPosterUrl();
            Glide.with(itemView.getContext())
                    .load(posterUrl)
                    .placeholder(android.R.drawable.ic_menu_gallery)
                    .error(android.R.drawable.ic_menu_close_clear_cancel)
                    .into(posterImageView);
        }
    }
}
```


**Выполнил**: Юдаев И. А.  
**Группа**: БСБО-09-22 
**Дата**: 18.12.2025
